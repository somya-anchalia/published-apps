<!DOCTYPE HTML>
<html>
<head>
    <!--=========================================================================-->
    <script src="static/scripts/jquery-3.5.1.min.js"></script>
    <script src="static/scripts/jquery.dataTables.min.js"></script>
    <!--=========================================================================-->
    <link rel="stylesheet" type="text/css" href="static/styles/cyb-qradar.css">
    <link rel="stylesheet" type="text/css" href="static/styles/util.css">
    <link rel="stylesheet" type="text/css" href="static/styles/main.css">
    <link rel="stylesheet" type="text/css" href="static/styles/jquery.dataTables.min.css">

    <link href="static/styles/bootstrap-datepicker.standalone.min.css" rel="stylesheet" />
    <script src="static/scripts/bootstrap-datepicker.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--=========================================================================================-->
    <link rel="stylesheet" type="text/css" href="static/styles/bootstrap4.4.1.min.css">
    
    <script src="static/scripts/bootstrap.min.js"></script>    
    <!----===========================================================================-->
    <script src="static/scripts/highcharts.js"></script>
    <!--==============================================================================-->

    <style>

        body {
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
            overflow: scroll;
        }

        .topnav {
            background-color: #333;
            position: fixed;
            z-index: 1;
            width: 100%;
        }

            .topnav a {
                float: left;
                color: #f2f2f2;
                text-align: center;
                padding: 14px 16px;
                text-decoration: none;
                font-size: 17px;
            }

                .topnav a:hover {
                    background-color: #ddd;
                    color: black;
                }

                .topnav a.active {
                    background-color: #4CAF50;
                    color: white;
                }

        .topnav-right {
            float: right;
        }
        /* .mainContant {
            position: absolute;
            margin-top: 80px;
        } */
    </style>

    <style>

        body {
            font-family: Arial;
        }

        .table {
            font-size: 14px;
        }

        .table th {
            padding: .50rem;
        }

        p {
            margin-bottom: .50rem;
        }



        /* Style the tab */
        .tab {
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

            /* Style the buttons inside the tab */
            .tab button {
                background-color: inherit;
                float: left;
                border: none;
                outline: none;
                cursor: pointer;
                padding: 14px 16px;
                transition: 0.3s;
                font-size: 17px;
            }

                /* Change background color of buttons on hover */
                .tab button:hover {
                    background-color: #ddd;
                }

                /* Create an active/current tablink class */
                .tab button.active {
                    background-color: #ccc;
                }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }


        #contextMenu {
            position: absolute;
            display: none;
            padding: 0px !important;
            border: 0px !important;
        }

        #contextMenu1 {
            position: absolute;
            display: none;
            padding: 0px !important;
            border: 0px !important;
        }
        .mystyle {
            display:none;
        }
        .mystyle1 {
            width: fit-content;
        }
    </style>
<script>window.QRADAR_APP_URL = "{{qradar_app_url}}"</script><script>window.CSRF_TOKEN = "{{csrf_token()}}"</script><script>window.QRADAR_APP_URL_PATH = "{{qradar_app_url_path}}"</script></head>
<body>
<form id="my_form" method="POST" autocomplete="off">
    <div class="topnav" style="display: flex;width: 100%;padding-bottom:5px">
        <!-- Brand/logo -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <div style="width: 65%;padding-top: 25px;">
            <img src="static/images/Cybereason.png" alt="logo" style="width:138px;height:30px;margin-left: 25px;">
        </div>
        <!-- Links -->
        <div class="topnav-right" style="margin-top: 10px; margin-bottom: 5px;">
            <table>
                <tr>
                    <td>
                        <select id="log_source_selector" name="log_source_selector" value="{{ form.log_sources }}" style="border: 0;border-radius: 0;background-color: #555;color: #fff;width: fit-content;display: flex;" class="form-control">
                        </select>
                    </td>
                    <td>
                        <div class='col-md-2' style="width: 80% !important;max-width:60% !important;display: flex;padding: 10px 10px !important;">
                            <input type="text" id="datepicker" style="border: 0;border-radius: 0;background-color: #555;color: #fff;" class="form-control" name="datepicker" value="{{form.datepicker}}" />
                            <span style="color:white;padding-top: 5px;">&nbsp;To&nbsp;</span>
                            <input type="text" id="enddate" style="border: 0;border-radius: 0;background-color: #555;color: #fff;" class="form-control" name="enddate" value="{{form.enddate}}" />
                            <div class="form-group  col-md-2" style="margin-bottom: 0px !important;">
                            <a style="padding: 10px 12px !important; background-color: #129ac8; width: 150px; border: 0; border-radius: 0; font-size: 18px; line-height: 19px; color: #fff; padding: 18px 105px; letter-spacing: 1px; -webkit-appearance: none; -moz-appearance: none; appearance: none; cursor: pointer;" href="" onclick="document.getElementById('my_form').submit(); return false;" class="btn btn-sm btn-info" role="button">Apply Filter</a>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

<div class="mainContant" >
<div style="display: flex;padding-bottom: 5px;padding-top: 80px;">
<div id="gadget1" class="" style="flex: 1 1 100%; box-sizing: border-box; padding-left:30px;padding-bottom:24px;padding-right: 12px;padding-top:24px;float:left;" >
<div class="gadgetContent">
<div class="title">
    <input type="hidden" name="chartContainerMalopsdata" id="chartContainerMalopsdata" value="{{ form.chartContainerMalops }}"/>
    <div class="title" style="flex-direction: row; box-sizing: border-box; display: flex;padding-bottom: 30px;">
        <span class="title">Malops by Activity</span>
    </div>
    <div id="chartContainerMalops" style="height: 300px;"></div>
</div>
</div>
</div>
<div id="gadget3" class="" style="flex: 1 1 100%; box-sizing: border-box; padding-right:30px;padding-bottom:24px;padding-top:24px;float:right;padding-left: 20px;" >
<div class="gadgetContent">
<div class="title">
    <input type="hidden" name="donutchart" id="donutchart" value="{{ form.donutchartData }}"/>
    <div class="title" style="flex-direction: row; box-sizing: border-box; display: flex;padding-bottom: 30px;">
        <span class="title">Malops by Type</span>
    </div>
    <div id="donutchartData" style="height: 280px;"></div>
</div>
</div>
</div>
<div id="gadget2" class="" style="flex: 1 1 100%; box-sizing: border-box; padding-right:30px;padding-bottom:24px;padding-top:24px;float:right;" >
<div class="gadgetContent">
<div class="title">
    <input type="hidden" name="piechart" id="piechart" value="{{ form.pieChartData }}"/>
    <div class="title" style="flex-direction: row; box-sizing: border-box; display: flex;padding-bottom: 30px;">
        <span class="title">Top Suspicions</span>
    </div>
    <div id="piechartData" style="height: 280px;"></div>
</div>
</div>
</div>
</div>
<div class="InnerContent mt-2">
<ul class="nav nav-tabs" role="tablist">
<li class="nav-item">
    <a class="nav-link active"  data-toggle="tab" href="#home">Malop Inbox</a>
</li>
</ul>
<div class="tab-content">
<div id="home" class="tab-pane fade show in active">
<div class="container" style="width: 100%; margin-top: 0px; max-width: 100%; padding-left: 0px; padding-right: 0px;"> 
    <input type="hidden" name="malop_events_data" id="malop_events_data" value="{{ form.malop_events }}"/>
    <table id="tbl_malop" class="table table-hover">
    <thead>
        
        <tr>
        <th>           </th>
        <th>Root Cause</th>
        <th>Detected Activity</th>
        <th>Affected Machines</th>
        <th>Severity</th>
        <th>Details</th>
        <th>Log Source</th>
        </tr>
    </thead>
    <tbody>
        {%for event in form.malop_events %}
        <tr>
        <td>
        <div>
            {% if event.malop_iconbase64 != "" %} 
            <img src="data:image/png;base64, {{event.malop_iconbase64}}" alt="Malop Icon" style="z-index: -1;" />
            {% else %}
            <img src = "static/images/small-icon_injection-b-7f074ac0.png"/>
            {% endif %}
        </div>
        </td>
        <td style="width: 40%;">
            <p><font size="2" color ="red">{{event.detection_type}}</font></p>
            <p><font size="4">{{event.root_cause_element_names}}</font></p>
            <p><img src = "static/images/description-3877239c.png"><font size="3"><font size="2" color ="#D1D0CE">&nbsp;{{event.event_name}}</font></p>
        </td>
        <td>
            {% autoescape false %}
            {{event.malop_activity_type | replace(",","<br/>")}}
            {% endautoescape %}
        </td>
        <td><img src = "static/images/machine-1f0f386f.png">&nbsp;{{event.machine_count|int}} Machines</td>
        <td>{{event.malop_severity}}</td>
        <td>
        <p><font size="2" color ="#A9A9A9">Created :</font>&nbsp; {{event.created_time}}</p>
        <p><font size="2" color ="#A9A9A9">Last Activity :</font>&nbsp; {{event.last_update_time}}</p>
        <p><font size="2" color ="#A9A9A9">Malop ID :</font>&nbsp; <label id="malop_guid">{{event.malop_id}}</label></p>
        <input type="hidden" name="malop_url" id="malop_url" value="{{ event.malop_url }}"/>
        </td>
        <td>{{event.log_source}}</td>
        </tr>
        {% endfor %}
    </tbody>
    </table>
</div>
</div>
</div>
</div>
</div>

<div id="contextMenu" class="dropdown-menu dropdown-menu-sm" style="border: 0px !important;padding:0px !important">
<ul class="dropdown-menu"  role="menu" aria-labelledby="dropdownMenu" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);padding:.5rem;display:block;position:static;margin-bottom:5px;">
    <li><a style="color:black;cursor:pointer;" tabindex="-1"  onclick="openMalopDetails(this);" target="_blank">Investigate Malop</a>
    </li>
    <li><a style="color:black;cursor:pointer;" tabindex="-1"  onclick="openMalopManagement(this);" target="_blank">Malop Management</a>
    </li>
    <li><a style="color:black;cursor:pointer;" tabindex="-1"  onclick="openDiscoveryBoard(this);" target="_blank">Discovery Board</a>
    </li>
</ul>
</div>
<script>
// Add class to Suspicion pie chart
$(document).ready( function () {
    var JSONString = document.getElementById('piechart').value;
    var JSONObject = JSON.parse(JSONString.replace(/u'/g,"'").replace(/'/g,"\""));
    if (Object.keys(JSONObject).length === 0) {
        var element = document.getElementById("gadget2");
        element.classList.add("mystyle");
    }
});
$(document).ready( function () {
    var JSONString = document.getElementById('donutchart').value;
    var JSONObject = JSON.parse(JSONString.replace(/u'/g,"'").replace(/'/g,"\""));
    var element = document.getElementsByTagName("body")[0];
    if (Object.keys(JSONObject).length > 0) {
        element.classList.add("mystyle1");
    }
});
</script>
<script>

var current_right_clicked_malop_url = "";


function openMalopDetails(event) {
    var malop_info = current_right_clicked_malop_url;
    window.open(malop_info,"Malop Details","width=720,height=380,resizable=no,scrollbars=no,status=yes,toolbar=no,location=no,menubar=no");
}

function openMalopManagement(event) {
    var malop_management = current_right_clicked_malop_url.split("#")[0] + "#/detection-inbox";
    window.open(malop_management,"Malop Management","width=720,height=380,resizable=no,scrollbars=no,status=yes,toolbar=no,location=no,menubar=no");
}

function openDiscoveryBoard(event) {
    var discovery_board = current_right_clicked_malop_url.split("#")[0] + "#/discovery/board";
    window.open(discovery_board,"Discovery Board","width=720,height=380,resizable=no,scrollbars=no,status=yes,toolbar=no,location=no,menubar=no");
}

$(function() {

var $contextMenu = $("#contextMenu");
var $contextMenu1 = $("#contextMenu1");

$("body").on("contextmenu", "#tbl_malop tr", function(e) {
    current_right_clicked_malop_url = $($(this)[0]).find('#malop_url')[0].defaultValue;
    $contextMenu.css({
        display: "block",
        left: e.pageX,
        top: e.pageY,
        background: "#FFFFFF",
        border: "1px solid #dddddd",
        padding: ".5rem .25rem",
    });
    return false;
});
$('html').click(function() {
    $contextMenu.hide();
});
$('html').click(function() {
    $contextMenu1.hide();
});

});

</script>
<script>
    $(function () {
    
    var JSONString = document.getElementById('chartContainerMalopsdata').value;
    var JSONObject = JSON.parse(JSONString.replace(/u'/g,"'").replace(/'/g,"\""));
    
    var barchartdata = [];
    var barchartcategories = [];
Object.keys(JSONObject).forEach(function(key) {
console.table('Key : ' + key + ', Value : ' + JSONObject[key])
barchartcategories[barchartcategories.length] = key;
barchartdata[barchartdata.length] = parseInt(JSONObject[key]);
})
    
Highcharts.chart('chartContainerMalops', {
chart: {
            type: 'column'
        },
        credits: {
        enabled: false
    },
    legend: {
        enabled: false
    },
        title: {
            text: ''
        },
        xAxis: {
            categories: barchartcategories
        },
        yAxis: {
            title: {
                text: ''
            }
        },
        plotOptions: {
        series: {
            cursor: 'pointer',
            point: {
                events: {
                    click: function() {
                        alert(this.category);
                    }
                }
            }
        }
        },
        series: [{
            name: 'Count',
            data: barchartdata
        }]
});  

});
</script>

<script>
$(document).ready(function(){
$( "#datepicker" ).datepicker({autoclose: true, format: 'mm/dd/yyyy'});
$( "#enddate" ).datepicker({autoclose: true, format: 'mm/dd/yyyy'});

var JSONString = document.getElementById('donutchart').value;
var JSONObject = JSON.parse(JSONString.replace(/u'/g,"'").replace(/'/g,"\""));
var donutchartdatasample=[];

$(JSONObject).each(function(ind,val){
donutchartdatasample.push([$(val)[0]["detection_type"],parseInt( $(val)[0]["malop_count"])]);
});


    var donutHighChartData=[];

    $(JSONObject).each(function(ind,val){
        donutHighChartData.push(
            
            {
                name: $(val)[0]["detection_type"],
                y: parseInt( $(val)[0]["malop_count"])
            }
        );
    });

    Highcharts.setOptions({
    colors: ['#8DEEEE', '#37FDFC', '#00CDCD', '#00FFFF', '#67E6EC',
        '#42C0FB', '#0198E1', '#1C86EE', '#0276FD', '#0147FA']

    });

    // Create the chart
    Highcharts.chart('donutchartData', {
        chart: {
            type: 'pie'
        },
        title: {
            text: ''
        },
        plotOptions: {
            pie: {
                shadow: false,
                center: ['50%', '50%'],
                    showInLegend : true
            }
        },
        tooltip: {
            valueSuffix: ''
        },
        credits: {
            enabled: false
        },
        series: [{
            name: 'Count',
            data: donutHighChartData,
            innerSize: '60%',
            size: '100%',
            dataLabels: {
                enabled: false
            }
        }],
        
        legend : {
            layout: 'vertical',
        align: 'right',
        verticalAlign: 'middle',
        borderWidth: 0,
        width: '60%'
        },
        responsive: {
            rules: [{
                condition: {
                    maxWidth: 400
                },
                chartOptions: {
                    series: [{
                    }, {
                        id: 'versions',
                        dataLabels: {
                            enabled: false
                        }
                    }]
                }
            }]
        },
        exporting: {
        enabled: false
        }
    });
    
    
    
});
</script>
<script>
$(document).ready(function(){
$( "#datepicker" ).datepicker({autoclose: true, format: 'mm/dd/yyyy'});
$( "#enddate" ).datepicker({autoclose: true, format: 'mm/dd/yyyy'});

var JSONString = document.getElementById('piechart').value;
var JSONObject = JSON.parse(JSONString.replace(/u'/g,"'").replace(/'/g,"\""));
var piechartdatasample=[];

$(JSONObject).each(function(ind,val){
piechartdatasample.push([$(val)[0]["suspicion_name"],parseInt( $(val)[0]["suspicion_count"])]);
});


    var pieHighChartData=[];

    $(JSONObject).each(function(ind,val){
        pieHighChartData.push(
            
            {
                name: $(val)[0]["suspicion_name"],
                y: parseInt( $(val)[0]["suspicion_count"])
            }
        );
    });

    Highcharts.setOptions({
    colors: ['#8DEEEE', '#37FDFC', '#00CDCD', '#00FFFF', '#67E6EC',
        '#42C0FB', '#0198E1', '#1C86EE', '#0276FD', '#0147FA']

    });

    // Create the chart
    Highcharts.chart('piechartData', {
        chart: {
            type: 'pie'
        },
        title: {
            text: ''
        },
        plotOptions: {
            pie: {
                shadow: false,
                center: ['50%', '50%'],
                    showInLegend : true
            }
        },
        tooltip: {
            valueSuffix: ''
        },
        credits: {
            enabled: false
        },
        series: [{
            name: 'Count',
            data: pieHighChartData,
            innerSize: '60%',
            size: '100%',
            dataLabels: {
                enabled: false
            }
        }],
        
        legend : {
            layout: 'vertical',
        align: 'right',
        verticalAlign: 'middle',
        borderWidth: 0,
        width: '60%'
        },
        responsive: {
            rules: [{
                condition: {
                    maxWidth: 400
                },
                chartOptions: {
                    series: [{
                    }, {
                        id: 'versions',
                        dataLabels: {
                            enabled: false
                        }
                    }]
                }
            }]
        },
        exporting: {
        enabled: false
        }
    });
    
    
    
});
</script>
<script>
    var csrf_token = "{{ csrf_token() }}";
    $.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|POST|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            alert(settings.type);
            xhr.setRequestHeader("X-CSRFToken", csrf_token);
        }
    }
    });
</script>
<script>
$(document).ready( function () {
    $('#tbl_malop').DataTable();
} );
</script>
<script>
// Adding log sources to dashboard filter
$(document).ready( function () {
    var optionsHTML = [];
    var select = document.getElementById("log_source_selector");
    var log_source_selector = document.querySelector('#log_source_selector');
    var value = log_source_selector.getAttribute('value').replace(/\'/g, '"');
    var log_sources = JSON.parse(value);
    optionsHTML.push("<option value='default' id='default' disabled selected>Log Source Filter</option>");
    for (index in log_sources) {
        optionsHTML.push("<option value='" + log_sources[index] + "' id='" + log_sources[index] + "'>" + log_sources[index] + "</option>");
    }
    select.innerHTML = optionsHTML.join('\n');
});
</script>
</form>
</body>
</html>